---
title: "Medidas dasométricas"
author: "Cristian Gañan"
date: ""
output: 
  pdf_document:
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE)

library(tidyverse)
library(ggplot2)
library(readxl)
```


```{r}
data<- read.csv2("Salida1.csv")

data<- data %>% mutate(Parcela = as.factor(Parcela),
                       Subparcela = as.factor(Subparcela)) %>% select(-c(X.))


data<- data %>% group_by(Parcela) %>% mutate(`Area ind(m)`= (pi/4)*(DAP_cm/100)^2, 
                                             Dap_f_cm = (d1+d2)/2, 
                                             `Area copa(m)` = (pi/4)*(D_copa)^2) %>% 
  mutate(`Error DAP`= ((abs(Dap_f_cm - DAP_cm))/ DAP_cm)*100, 
         `Error alt` = ((abs(Alt_med - Alt_cal))/ Alt_cal)*100) 

data1<- data %>% rename(DAP_obs= DAP_cm, DAP_est= Dap_f_cm, 
                Alt_obs= Alt_cal, Alt_est= Alt_med) %>% select(DAP_obs, DAP_est, Alt_obs, Alt_est,
                                                                       `Error DAP`, `Error alt`) %>% 
  filter(DAP_est != "NA")
data1

data1 %>% group_by(Parcela)%>% summarise(DAP_obs= mean(DAP_obs), DAP_est= mean(DAP_est), Alt_obs= mean(Alt_obs), Alt_est= mean(Alt_est), `Error DAP`= mean(`Error DAP`), `Error alt`= mean(`Error alt`))

```



```{r}
data %>% group_by(Subparcela) %>% 
  summarise(a= sum(`Area ind(m)`), 
            Dcm= sqrt(mean(DAP_cm^2)),
            Area_copa_p= sum(`Area copa(m)`)/length(Subparcela), 
            Altura_p= sum(Alt_cal)/length(Subparcela)) %>% 
  mutate(`Area basal`= a*10000/100) %>% 
  select(c(Subparcela, Dcm, `Area basal`, Area_copa_p, 
           Altura_p)) %>% slice(-c(1))

data %>% group_by(Parcela) %>% 
  summarise(a= sum(`Area ind(m)`), N_ind= length(Parcela),
            Dcm= sqrt(mean(DAP_cm^2))) %>% 
  mutate(`Area basal`= a*10000/250) %>% 
  select(c(Parcela, Dcm, `Area basal`))


```

## Distribuciónes DAP

```{r}

ggplot(data, mapping = aes(x= DAP_cm, col= "pink")) +
  geom_histogram(bins = 7, origin= 15) + labs(y= "Individuos", title = "Distribuciónes diamétricas DAP") +
  scale_x_continuous(breaks = seq(12, 50, 6)) + theme(legend.position = "none")
  
```


## distribuciónes alt

```{r}
data1<- data %>% filter(Alt_cal != "NA")

ggplot(data1, mapping = aes(x= Alt_cal, col= "pink")) +
  geom_histogram(binwidth = 4) + labs(y= "Individuos", title = "Distribuciónes diamétricas Altura") +
  scale_x_continuous(breaks = seq(4, 25, 4)) +theme(legend.position = "none") 

```


## distribuciones copa

```{r}
ggplot(data, mapping = aes(x= `Area copa(m)`, col= "pink")) +
  geom_histogram(binwidth = 10) + labs(y= "Individuos", title = "Distribuciónes diamétricas Area de copa") +
  theme(legend.position = "none") + scale_x_continuous(breaks = seq(0, 65, 10)) 
```

#Modelos

```{r}
data1<- read_xlsx("datoscampo.xlsx")
data2<- read_xlsx("Libro1_datos_daso_g3.xlsx")
data3<- read_xlsx("SantaElena.xlsx")

data1<- data1 %>% mutate(`Area copa(m)`= (pi/4)*((D1_DC_m+D2_DC_m)/2)^2) %>% 
  rename(Altura= Altura_Laser, DAP_cm= DAP_cm_D) %>% select(Parcela, DAP_cm, Altura, 
                                                            `Area copa(m)`) %>% 
  filter(Altura != "NA")

data2<- data2 %>% mutate(Parcela= as.factor(Parcela), Subparcela= as.factor(Subparcela)) %>%  
  mutate(DAP_cm= (F1+F2)/2, `Area copa(m)`= (pi/4)*((D1+D2)/2)^2) %>% 
  rename(Altura= Hipsometro) %>% 
  group_by(Subparcela) %>% mutate(Parcela= if_else(Parcela == "1", "7", "8")) %>% 
  select(Parcela, DAP_cm, Altura, `Area copa(m)`) %>% filter(Altura != "NA")

data2<- data2[,-1]

data3<- data3 %>% mutate(Parcela= as.factor(Parcela), dc_1_m= as.numeric(dc_1_m), 
                         dc_2_m= as.numeric(dc_2_m)) %>%
  mutate(`Area copa(m)`= (pi/4)*((dc_1_m+dc_2_m)/2)^2) %>% 
  rename(Altura= H_total, parcela= Parcela) %>% group_by(parcela) %>% 
  mutate(Parcela= if_else(parcela == "P1", "9", if_else(parcela == "P2", "10", "11"))) %>% 
  filter(Altura != "NA") %>% select(Parcela, DAP_cm, Altura, `Area copa(m)`)

data3<- data3[,-1]

data<- data %>% rename(Altura= Alt_cal) %>% select(Parcela, DAP_cm, Altura, `Area copa(m)`) %>% 
  filter(Altura != "NA")

data1<- as.tibble(data1)
data2<- as.tibble(data2)
data3<- as.tibble(data3)
data<- as.tibble(data)

data1$Parcela<- as.factor(data1$Parcela)

datos<- rbind(data, data1, data2, data3)

datos<- datos %>% mutate(DAP_cm= as.numeric(DAP_cm), 
                         Altura= as.numeric(Altura))
```


## Modelo lineal (altura dap)

```{r}
linear<- lm(Altura ~ DAP_cm, data= datos)

plot(rstandard(linear))
abline(0,0, col= "red")



ggplot(datos , mapping = aes(x= DAP_cm, y= Altura)) +
  geom_point() +
  geom_smooth(broom::augment(linear), mapping = aes(x= DAP_cm, y= .fitted))
```

## Modelo exponencial (altura dap)

```{r}
nlinear<- lm(log(Altura) ~ log(DAP_cm), data= datos)

ggplot(datos, mapping = aes(x= DAP_cm, y= Altura)) +
  geom_point() + 
  geom_smooth(broom::augment(nlinear), mapping = aes(x= exp(log.DAP_cm.), 
                                                     y= exp(((anova(nlinear)$"Mean Sq"[2])/2)+2.3479291+0.1552072*log.DAP_cm.)))

prueba<- broom::augment(nlinear)

prueba<- prueba %>% mutate(fitted=  exp(((anova(nlinear)$"Mean Sq"[2])/2)+2.3479291+0.1552072*log.DAP_cm.))%>% 
  mutate(resid= exp(log.DAP_cm.)-fitted)

RSE <- sqrt(sum(prueba$resid^2, na.rm = TRUE)/summary(nlinear)$df[2])


#n<- nls(Altura ~ a*DAP_cm^b, start = list(a= 2.3479291, b= 0.1552072), data = datos)

#broom::glance(n)

#ggplot(datos, mapping = aes(x= DAP_cm, y= Altura)) +
  #geom_point() +
  #geom_smooth(broom::augment(n), mapping = aes(x= DAP_cm, 
                                               #y= .fitted))
```


\begin{table}[htbp]
\begin{center}
\begin{tabular}{|l|l||l|l|l|}
\hline
Modelo & ValorP & RSE & Shapiro test & AIC\\
\hline \hline 
$H= 13.92+0.14*DAP$ & $0.0035402$ & $4.21$ & $0.389$ & $421.0029$ \\ 
$H= exp(2.38 + 0.155*log(DAP))$ & $0.0095268$ & $9.73$ & &  \\ 
\hline
\end{tabular}
\caption{Modelos altura DAP}
\end{center}
\end{table}


## Modelo lineal (acopa dap) 

```{r}
datos<- datos %>% filter(`Area copa(m)` != 0)

linear<- lm(`Area copa(m)` ~ DAP_cm , data= datos)

plot(rstandard(linear))
abline(0,0, col= "red")



ggplot(datos , mapping = aes(x= DAP_cm, y= `Area copa(m)`)) +
  geom_point() +
  geom_smooth(broom::augment(linear), mapping = aes(x= DAP_cm, y= .fitted))


```


## Modelo Exp(acopa dap)

```{r}
nlinear<- lm(log(`Area copa(m)`) ~ log(DAP_cm), data= datos)

ggplot(datos, mapping = aes(x= DAP_cm, y= `Area copa(m)`)) +
  geom_point() + 
  geom_smooth(broom::augment(nlinear), mapping = aes(x= exp(log.DAP_cm.), 
                                                     y= exp(((anova(nlinear)$"Mean Sq"[2])/2)+0.1885491+0.8910002*log.DAP_cm.)))

prueba<- broom::augment(nlinear)

prueba<- prueba %>% mutate(fitted=  exp(((anova(nlinear)$"Mean Sq"[2])/2)+0.1885491+0.8910002*log.DAP_cm.))%>% 
  mutate(resid= exp(log.DAP_cm.)-fitted)

RSE <- sqrt(sum(prueba$resid^2, na.rm = TRUE)/summary(nlinear)$df[2])


#n<- nls(`Area copa(m)` ~ a*DAP_cm^b, start = list(a= 0.1885491, b= 0.8910002), data = datos)

#broom::glance(n)

#ggplot(datos, mapping = aes(x= DAP_cm, y= `Area copa(m)`)) +
  #geom_point() +
  #geom_smooth(broom::augment(n), mapping = aes(x= DAP_cm, 
                                               #y= .fitted))
```

\begin{table}[htbp]
\begin{center}
\begin{tabular}{|l|l||l|l|l|}
\hline
Modelo & ValorP & RSE & Shapiro test & AIC\\
\hline \hline 
$Acopa= -2.404+1.302*DAP$ & $1.300739e-09$ & $15.798$ & $0.0045$ & $595.759$ \\ 
$Acopa= exp(0.661+0.891*log(DAP))$ & $0.0000831$ & $8.435$ & &  \\ 
\hline
\end{tabular}
\caption{Modelos Acopa DAP}
\end{center}
\end{table}
















